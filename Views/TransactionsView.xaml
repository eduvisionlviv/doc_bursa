<UserControl x:Class="doc_bursa.Views.TransactionsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:doc_bursa.ViewModels"
             xmlns:cvt="clr-namespace:doc_bursa.Converters"
             xmlns:models="clr-namespace:doc_bursa.Models">
    <UserControl.Resources>
        <cvt:AmountToColorConverter x:Key="AmountToColorConverter"/>
        <cvt:NullToBoolConverter x:Key="NullToBoolConverter"/>
    </UserControl.Resources>

    <Grid Background="#0B1220">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Транзакції" 
                  FontSize="28" 
                  FontWeight="SemiBold" 
                  Margin="0,0,0,20"
                  Foreground="#E5E7EB"/>

        <Grid Grid.Row="1" Margin="0,0,0,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="200"/>
            </Grid.ColumnDefinitions>

            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                    Style="{StaticResource SearchBoxStyle}"
                    Margin="0,0,10,0"/>

            <ComboBox Grid.Column="1" 
                     ItemsSource="{Binding Categories}" 
                     SelectedItem="{Binding SelectedCategory}"/>
        </Grid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,0,10">
            <Button Content="◀" Width="40" Command="{Binding PreviousPageCommand}"/>
            <TextBlock Text="{Binding CurrentPage, StringFormat='Сторінка {0}'}" Margin="10,0" Foreground="#E5E7EB"/>
            <TextBlock Text="{Binding TotalPages, StringFormat='з {0}'}" Foreground="#E5E7EB"/>
            <Button Content="▶" Width="40" Command="{Binding NextPageCommand}" Margin="10,0,0,0"/>
            <StackPanel Orientation="Horizontal" Margin="20,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="Комісія:" Foreground="#E5E7EB" VerticalAlignment="Center" Margin="0,0,6,0"/>
                <TextBox Width="80"
                         Text="{Binding TransferCommissionInput, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,10,0"/>
                <Button Content="Звірити авто" Command="{Binding ReconcileTransfersCommand}" Margin="0,0,6,0"/>
                <Button Content="Переказ" Command="{Binding MarkAsTransferCommand}" Margin="0,0,6,0"/>
                <Button Content="Підтвердити/оновити" Command="{Binding ConfirmTransferCommand}"/>
            </StackPanel>
        </StackPanel>

        <Border Grid.Row="3" Style="{StaticResource CardStyle}">
            <DataGrid ItemsSource="{Binding Transactions}" 
                     SelectedItem="{Binding SelectedTransaction}"
                     AutoGenerateColumns="False"
                     CanUserAddRows="False"
                     IsReadOnly="True"
                     EnableRowVirtualization="True"
                     EnableColumnVirtualization="True"
                     VirtualizingPanel.IsVirtualizing="True"
                     VirtualizingPanel.VirtualizationMode="Recycling"
                     VirtualizingPanel.CacheLength="20,20"
                     VirtualizingPanel.CacheLengthUnit="Item"
                     GridLinesVisibility="None"
                     HeadersVisibility="Column"
                     Background="#0F172A"
                     BorderThickness="0">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Дата" 
                                       Binding="{Binding Date, StringFormat='dd.MM.yyyy'}" 
                                       Width="100"/>
                    <DataGridTextColumn Header="Опис" 
                                       Binding="{Binding Description}" 
                                       Width="*"/>
                    <DataGridTextColumn Header="Категорія" 
                                       Binding="{Binding Category}" 
                                       Width="150"/>
                    <DataGridCheckBoxColumn Header="Переказ" Binding="{Binding IsTransfer}" Width="90"/>
                    <DataGridTextColumn Header="Статус" Binding="{Binding TransferStatus}" Width="120"/>
                    <DataGridTextColumn Header="Комісія" Binding="{Binding TransferCommission, StringFormat='{}{0:N2}'}" Width="100"/>
                    <DataGridTextColumn Header="Сума" 
                                       Binding="{Binding Amount, StringFormat='{}{0:N2} ₴'}" 
                                       Width="120">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{Binding Amount, Converter={StaticResource AmountToColorConverter}}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Джерело" 
                                       Binding="{Binding Source}" 
                                       Width="100"/>
                </DataGrid.Columns>

                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Змінити категорію">
                            <MenuItem Header="Продукти" Command="{Binding UpdateCategoryCommand}" CommandParameter="Продукти"/>
                            <MenuItem Header="Транспорт" Command="{Binding UpdateCategoryCommand}" CommandParameter="Транспорт"/>
                            <MenuItem Header="Ресторани" Command="{Binding UpdateCategoryCommand}" CommandParameter="Ресторани"/>
                            <MenuItem Header="Здоров'я" Command="{Binding UpdateCategoryCommand}" CommandParameter="Здоров'я"/>
                            <MenuItem Header="Розваги" Command="{Binding UpdateCategoryCommand}" CommandParameter="Розваги"/>
                            <MenuItem Header="Інше" Command="{Binding UpdateCategoryCommand}" CommandParameter="Інше"/>
                        </MenuItem>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>
        </Border>

        <Expander Grid.Row="5" Header="Split-майстер" Foreground="#E5E7EB" IsExpanded="{Binding IsSplitWizardVisible}" Background="#0F172A" Padding="10">
            <StackPanel>
                <TextBlock Text="Налаштуйте дочірні транзакції так, щоб сума дорівнювала батьківській." Foreground="#9CA3AF" Margin="0,0,0,8"/>
                <ItemsControl ItemsSource="{Binding SplitChildren}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,0,0,6">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="140"/>
                                    <ColumnDefinition Width="80"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Date, StringFormat=dd.MM.yyyy}" VerticalAlignment="Center" Foreground="#E5E7EB"/>
                                <TextBox Grid.Column="1" Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Margin="8,0" />
                                <TextBox Grid.Column="2" Text="{Binding Amount, UpdateSourceTrigger=PropertyChanged}" Margin="8,0"/>
                                <Button Grid.Column="3" Content="✖" Command="{Binding DataContext.RemoveSplitRowCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}" />
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                    <Button Content="Додати рядок" Command="{Binding AddSplitRowCommand}" />
                    <Button Content="Зберегти" Command="{Binding SaveSplitCommand}" Margin="8,0,0,0"/>
                    <Button Content="Скасувати" Command="{Binding CancelSplitWizardCommand}" Margin="8,0,0,0"/>
                    <TextBlock Text="{Binding SplitValidationMessage}" Foreground="OrangeRed" Margin="12,4,0,0"/>
                </StackPanel>
            </StackPanel>
        </Expander>
    </Grid>
</UserControl>
