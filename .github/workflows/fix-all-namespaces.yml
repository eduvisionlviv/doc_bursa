name: Apply Critical Patches

on:
  workflow_dispatch:
    inputs:
      what_if:
        description: '–¢—ñ–ª—å–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–∏, —â–æ –±—É–¥–µ –∑–º—ñ–Ω–µ–Ω–æ (–±–µ–∑ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è)'
        required: false
        default: 'false'
        type: boolean

jobs:
  apply-patches:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Create patches directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path patches -Force | Out-Null
          Write-Host "üìÅ –°—Ç–≤–æ—Ä–µ–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é patches" -ForegroundColor Green
      
      - name: Apply critical patches
        shell: pwsh
        run: |
          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ErrorActionPreference –Ω–∞ Continue
          $ErrorActionPreference = "Continue"
          
          Write-Host "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ enhance-project.ps1" -ForegroundColor Cyan
          
          if (-not (Test-Path "scripts/enhance-project.ps1")) {
            Write-Error "‚ùå –°–∫—Ä–∏–ø—Ç scripts/enhance-project.ps1 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
            exit 1
          }
          
          # –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–∫—Ä–∏–ø—Ç
          & "scripts/enhance-project.ps1" -WhatIf:$${{ inputs.what_if }} -Verbose
          
          # –ó–∞–≤–∂–¥–∏ —É—Å–ø—ñ—à–Ω–∏–π –≤–∏—Ö—ñ–¥, —â–æ–± workflow –ø—Ä–æ–¥–æ–≤–∂–∏–≤—Å—è
          Write-Host "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–≤ —Ä–æ–±–æ—Ç—É" -ForegroundColor Green
          exit 0  # <-- –í–ê–ñ–õ–ò–í–û: –ø—Ä–∏–º—É—Å–æ–≤–∏–π —É—Å–ø—ñ—à–Ω–∏–π –≤–∏—Ö—ñ–¥
      
      - name: Check for changes
        id: check_changes
        shell: pwsh
        run: |
          git add -A
          $changes = git status --porcelain
          
          if ($changes) {
            Write-Host "üìã –ó–Ω–∞–π–¥–µ–Ω–æ –∑–º—ñ–Ω–∏:" -ForegroundColor Green
            Write-Host $changes
            echo "HAS_CHANGES=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ö†Ô∏è –ó–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ" -ForegroundColor Yellow
            echo "HAS_CHANGES=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.HAS_CHANGES == 'true' && inputs.what_if != 'true'
        shell: pwsh
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git commit -m "feat: –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–∞—Ç—á—ñ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
          
          - –†–æ–∑—à–∏—Ä–µ–Ω–∏–π CSV Import –∑ –∞–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º –±–∞–Ω–∫—ñ–≤
          - ML.NET –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
          - –†–æ–∑—É–º–Ω–∞ –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è (Levenshtein)
          - –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –±—é–¥–∂–µ—Ç—É
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ GitHub Actions"
          
          git push
      
      - name: Upload patch artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: patches
          path: |
            patches/
            *.log
          retention-days: 7
          if-no-files-found: warn
      
      - name: Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "`nüìä –ü—ñ–¥—Å—É–º–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:" -ForegroundColor Cyan
          Write-Host "================================" -ForegroundColor Cyan
          
          if ("${{ steps.check_changes.outputs.HAS_CHANGES }}" -eq "true") {
            Write-Host "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π" -ForegroundColor Green
          } elseif ("${{ inputs.what_if }}" -eq "true") {
            Write-Host "‚ö†Ô∏è  –ë—É–≤ –∑–∞–ø—É—â–µ–Ω–∏–π —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (WhatIf)" -ForegroundColor Yellow
          } else {
            Write-Host "‚ÑπÔ∏è  –ó–º—ñ–Ω –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ (–≤—Å–µ –≤–∂–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ)" -ForegroundColor Blue
          }
