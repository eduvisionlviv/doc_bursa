name: Apply Critical Patches

on:
  workflow_dispatch:  # –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫
    inputs:
      what_if:
        description: '–¢—ñ–ª—å–∫–∏ –ø–æ–∫–∞–∑–∞—Ç–∏, —â–æ –±—É–¥–µ –∑–º—ñ–Ω–µ–Ω–æ (–±–µ–∑ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è)'
        required: false
        default: 'false'
        type: boolean
  
  push:
    branches:
      - main
    paths:
      - 'scripts/enhance-project.ps1'
      - '.github/workflows/fix-all-namespaces.yml'

jobs:
  apply-patches:
    runs-on: windows-latest  # –í–∞–∂–ª–∏–≤–æ: PowerShell —Å–∫—Ä–∏–ø—Ç –¥–ª—è Windows
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–ª—è commit/push
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Apply critical patches
        shell: pwsh
        run: |
          Write-Host "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ enhance-project.ps1"
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Å–∫—Ä–∏–ø—Ç–∞
          if (-not (Test-Path "scripts/enhance-project.ps1")) {
            Write-Error "–°–∫—Ä–∏–ø—Ç scripts/enhance-project.ps1 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
            exit 1
          }
          
          # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
          if ("${{ inputs.what_if }}" -eq "true") {
            Write-Host "‚ö†Ô∏è –†–µ–∂–∏–º WhatIf (—Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞)"
            & "scripts/enhance-project.ps1" -WhatIf -Verbose
          } else {
            Write-Host "‚úÖ –†–µ–∂–∏–º –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–∞—Ç—á—ñ–≤"
            & "scripts/enhance-project.ps1" -Verbose
          }
      
      - name: Check for changes
        id: check_changes
        shell: pwsh
        run: |
          git add -A
          $changes = git status --porcelain
          
          if ($changes) {
            Write-Host "üìã –ó–Ω–∞–π–¥–µ–Ω–æ –∑–º—ñ–Ω–∏:" -ForegroundColor Green
            Write-Host $changes
            echo "HAS_CHANGES=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ö†Ô∏è –ó–º—ñ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ" -ForegroundColor Yellow
            echo "HAS_CHANGES=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.HAS_CHANGES == 'true' && inputs.what_if != 'true'
        shell: pwsh
        run: |
          # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è commit
          $commitMessage = @"
          feat: –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–∞—Ç—á—ñ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É
          
          - –†–æ–∑—à–∏—Ä–µ–Ω–∏–π CSV Import –∑ –∞–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è–º –±–∞–Ω–∫—ñ–≤
          - ML.NET –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π
          - –†–æ–∑—É–º–Ω–∞ –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—è (Levenshtein)
          - –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –±—é–¥–∂–µ—Ç—É
          
          –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ GitHub Actions
          "@
          
          git commit -m $commitMessage
          
          # Push –∑–º—ñ–Ω
          git push
          Write-Host "‚úÖ –ó–º—ñ–Ω–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π" -ForegroundColor Green
      
      - name: Upload patch artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: patches
          path: patches/
          retention-days: 7
      
      - name: Summary
        shell: pwsh
        run: |
          Write-Host "`nüìä –ü—ñ–¥—Å—É–º–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:" -ForegroundColor Cyan
          Write-Host "================================" -ForegroundColor Cyan
          
          if ("${{ steps.check_changes.outputs.HAS_CHANGES }}" -eq "true") {
            Write-Host "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π" -ForegroundColor Green
          } elseif ("${{ inputs.what_if }}" -eq "true") {
            Write-Host "‚ö†Ô∏è  –ë—É–≤ –∑–∞–ø—É—â–µ–Ω–∏–π —Ä–µ–∂–∏–º –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (WhatIf)" -ForegroundColor Yellow
            Write-Host "   –©–æ–± –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø–∞—Ç—á—ñ, –∑–∞–ø—É—Å—Ç—ñ—Ç—å workflow –∑ WhatIf=false" -ForegroundColor Yellow
          } else {
            Write-Host "‚ÑπÔ∏è  –ó–º—ñ–Ω –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ (–≤—Å–µ –≤–∂–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ)" -ForegroundColor Blue
          }
          
          Write-Host "`nüìù –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:" -ForegroundColor Cyan
          Write-Host "1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–º—ñ–Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ: git pull" -ForegroundColor White
          Write-Host "2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –ø—Ä–æ–µ–∫—Ç: dotnet run" -ForegroundColor White
          Write-Host "3. –ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ CSV —ñ–º–ø–æ—Ä—Ç –∑ —Ä—ñ–∑–Ω–∏–º–∏ –±–∞–Ω–∫–∞–º–∏" -ForegroundColor White
